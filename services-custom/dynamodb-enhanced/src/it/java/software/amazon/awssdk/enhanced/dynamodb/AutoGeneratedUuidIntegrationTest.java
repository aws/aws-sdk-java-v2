/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 *  http://aws.amazon.com/apache2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

package software.amazon.awssdk.enhanced.dynamodb;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static software.amazon.awssdk.enhanced.dynamodb.UuidTestUtils.isValidUuid;

import java.util.List;
import java.util.stream.Collectors;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;
import software.amazon.awssdk.enhanced.dynamodb.extensions.AutoGeneratedUuidExtension;
import software.amazon.awssdk.enhanced.dynamodb.model.BeanRecord;
import software.amazon.awssdk.enhanced.dynamodb.model.TransactWriteItemsEnhancedRequest;
import software.amazon.awssdk.enhanced.dynamodb.model.WriteBatch;
import software.amazon.awssdk.enhanced.dynamodb.model.autogeneratedkeys.AutogeneratedKeyConflictingRecord;
import software.amazon.awssdk.enhanced.dynamodb.model.autogeneratedkeys.AutogeneratedUuidInvalidTypeRecord;
import software.amazon.awssdk.enhanced.dynamodb.model.autogeneratedkeys.AutogeneratedUuidRecord;
import software.amazon.awssdk.services.dynamodb.DynamoDbClient;

public class AutoGeneratedUuidIntegrationTest extends DynamoDbEnhancedIntegrationTestBase {

    private static final String TABLE_NAME = createTestTableName();

    private static DynamoDbClient dynamoDbClient;
    private static DynamoDbEnhancedClient enhancedClient;
    private static DynamoDbTable<AutogeneratedUuidRecord> mappedTable;

    @BeforeClass
    public static void beforeClass() {
        dynamoDbClient = createDynamoDbClient();
        enhancedClient = DynamoDbEnhancedClient.builder()
                                               .dynamoDbClient(dynamoDbClient)
                                               .extensions(AutoGeneratedUuidExtension.create())
                                               .build();
        mappedTable = enhancedClient.table(TABLE_NAME, TableSchema.fromClass(AutogeneratedUuidRecord.class));
        mappedTable.createTable();
        dynamoDbClient.waiter().waitUntilTableExists(r -> r.tableName(TABLE_NAME));
    }

    @After
    public void tearDown() {
        mappedTable.scan()
                   .items()
                   .forEach(record -> mappedTable.deleteItem(record));
    }

    @AfterClass
    public static void afterClass() {
        try {
            dynamoDbClient.deleteTable(r -> r.tableName(TABLE_NAME));
        } finally {
            dynamoDbClient.close();
        }
    }

    @Test
    public void putItem_whenKeysNotPopulated_generatesNewUuids() {
        AutogeneratedUuidRecord record = new AutogeneratedUuidRecord();

        mappedTable.putItem(record);
        AutogeneratedUuidRecord result = mappedTable.scan().items().stream().findFirst()
                                                    .orElseThrow(() -> new AssertionError("No record found"));
        isValidUuid(result.getId());
        isValidUuid(result.getSortKey());
    }

    @Test
    public void putItem_whenKeysAlreadyPopulated_replacesExistingUuids() {
        AutogeneratedUuidRecord record = new AutogeneratedUuidRecord();
        record.setId("existing-id");
        record.setSortKey("existing-sk");

        mappedTable.putItem(record);
        AutogeneratedUuidRecord result = mappedTable.scan().items().stream().findFirst()
                                                    .orElseThrow(() -> new AssertionError("No record found"));

        isValidUuid(result.getId());
        isValidUuid(result.getSortKey());
        assertThat(result.getId()).isNotEqualTo("existing-id");
        assertThat(result.getSortKey()).isNotEqualTo("existing-sk");
    }

    @Test
    public void batchWrite_whenKeysNotPopulated_generatesNewUuids() {
        AutogeneratedUuidRecord record1 = new AutogeneratedUuidRecord();
        AutogeneratedUuidRecord record2 = new AutogeneratedUuidRecord();

        enhancedClient.batchWriteItem(req -> req.addWriteBatch(
            WriteBatch.builder(AutogeneratedUuidRecord.class)
                      .mappedTableResource(mappedTable)
                      .addPutItem(record1)
                      .addPutItem(record2)
                      .build()));
        List<AutogeneratedUuidRecord> results = mappedTable.scan().items().stream().collect(Collectors.toList());

        assertThat(results.size()).isEqualTo(2);
        isValidUuid(results.get(0).getId());
        isValidUuid(results.get(1).getId());
        isValidUuid(results.get(0).getSortKey());
        isValidUuid(results.get(1).getSortKey());
    }

    @Test
    public void batchWrite_whenKeysAlreadyPopulated_generatesNewUuids() {
        AutogeneratedUuidRecord record1 = new AutogeneratedUuidRecord();
        record1.setId("existing-id-1");
        record1.setSortKey("existing-sk-1");

        AutogeneratedUuidRecord record2 = new AutogeneratedUuidRecord();
        record2.setId("existing-id-2");
        record2.setSortKey("existing-sk-2");

        enhancedClient.batchWriteItem(req -> req.addWriteBatch(
            WriteBatch.builder(AutogeneratedUuidRecord.class)
                      .mappedTableResource(mappedTable)
                      .addPutItem(record1)
                      .addPutItem(record2)
                      .build()));

        List<AutogeneratedUuidRecord> results = mappedTable.scan().items().stream().collect(Collectors.toList());

        assertThat(results.size()).isEqualTo(2);
        isValidUuid(results.get(0).getId());
        isValidUuid(results.get(1).getId());
        isValidUuid(results.get(0).getSortKey());
        isValidUuid(results.get(1).getSortKey());

        assertThat(results.get(0).getId()).isNotEqualTo("existing-id-1");
        assertThat(results.get(1).getId()).isNotEqualTo("existing-id-2");
        assertThat(results.get(0).getSortKey()).isNotEqualTo("existing-sk-1");
        assertThat(results.get(1).getSortKey()).isNotEqualTo("existing-sk-2");
    }

    @Test
    public void transactWrite_whenKeysNotPopulated_generatesNewUuids() {
        AutogeneratedUuidRecord record = new AutogeneratedUuidRecord();

        enhancedClient.transactWriteItems(
            TransactWriteItemsEnhancedRequest.builder()
                                             .addPutItem(mappedTable, record)
                                             .build());
        AutogeneratedUuidRecord result = mappedTable.scan().items().stream().findFirst()
                                                    .orElseThrow(() -> new AssertionError("No record found"));

        isValidUuid(result.getId());
        isValidUuid(result.getSortKey());
    }

    @Test
    public void transactWrite_whenKeysAlreadyPopulated_generatesNewUuids() {
        AutogeneratedUuidRecord record = new AutogeneratedUuidRecord();
        record.setId("existing-id");
        record.setSortKey("existing-sk");

        enhancedClient.transactWriteItems(
            TransactWriteItemsEnhancedRequest.builder()
                                             .addPutItem(mappedTable, record)
                                             .build());
        AutogeneratedUuidRecord result = mappedTable.scan().items().stream().findFirst()
                                                    .orElseThrow(() -> new AssertionError("No record found"));

        isValidUuid(result.getId());
        isValidUuid(result.getSortKey());
        assertThat(result.getId()).isNotEqualTo("existing-id");
        assertThat(result.getSortKey()).isNotEqualTo("existing-sk");
    }

    @Test
    public void putItem_whenAnnotationInConflictWithAutogeneratedKeyAnnotation_throwsException() {
        String tableName = createTestTableName();
        DynamoDbTable<AutogeneratedKeyConflictingRecord> mappedTable =
            enhancedClient.table(tableName, TableSchema.fromClass(AutogeneratedKeyConflictingRecord.class));

        try {
            mappedTable.createTable();
            dynamoDbClient.waiter().waitUntilTableExists(r -> r.tableName(tableName));

            assertThatThrownBy(() -> mappedTable.putItem(new AutogeneratedKeyConflictingRecord()))
                .isInstanceOf(IllegalArgumentException.class)
                .hasMessageContaining("cannot have both @DynamoDbAutoGeneratedKey and @DynamoDbAutoGeneratedUuid");
        } finally {
            try {
                mappedTable.deleteTable();
            } catch (Exception ignored) {
            }
        }
    }

    @Test
    public void putItem_whenNoAutogeneratedUuidAnnotationIsPresent_doesNotRegenerateUuids() {
        String tableName = createTestTableName();
        DynamoDbTable<BeanRecord> mappedTable = enhancedClient.table(tableName, TableSchema.fromClass(BeanRecord.class));

        try {
            mappedTable.createTable();
            dynamoDbClient.waiter().waitUntilTableExists(r -> r.tableName(tableName));

            BeanRecord record = new BeanRecord();
            record.setId("existing-id");
            record.setSortKey("existing-sk");
            record.setGsiPk("existing-gsiPk");
            record.setGsiSk("existing-gsiSk");
            record.setData("data");

            mappedTable.putItem(record);
            BeanRecord retrieved = mappedTable.getItem(
                r -> r.key(k -> k.partitionValue("existing-id").sortValue("existing-sk")));
            assertThat(retrieved.getId()).isEqualTo("existing-id");
            assertThat(retrieved.getSortKey()).isEqualTo("existing-sk");
            assertThat(retrieved.getGsiPk()).isEqualTo("existing-gsiPk");
            assertThat(retrieved.getGsiSk()).isEqualTo("existing-gsiSk");
            assertThat(retrieved.getData()).isEqualTo("data");
        } finally {
            try {
                mappedTable.deleteTable();
            } catch (Exception ignored) {
            }
        }
    }

    @Test
    public void createBean_givenAutogeneratedUuidAnnotationAppliedOnNonStringAttributeType_throwsException() {
        assertThatThrownBy(() -> TableSchema.fromBean(AutogeneratedUuidInvalidTypeRecord.class))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessageContaining("not a suitable Java Class type to be used as a Auto Generated Uuid attribute")
            .hasMessageContaining("Only String Class type is supported");
    }
}
