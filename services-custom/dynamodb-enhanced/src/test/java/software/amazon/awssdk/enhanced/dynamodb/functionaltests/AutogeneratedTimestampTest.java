/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 *  http://aws.amazon.com/apache2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

package software.amazon.awssdk.enhanced.dynamodb.functionaltests;

import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.hamcrest.CoreMatchers.everyItem;
import static org.hamcrest.CoreMatchers.notNullValue;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.hasProperty;
import static org.hamcrest.Matchers.is;
import static org.junit.Assert.assertNotNull;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_CHILD1;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_CHILD2;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_LEVEL1;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_LEVEL2;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_LEVEL3;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ATTR_LEVEL4;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.CHILD1_KEY;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.CHILD2_KEY;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.ID_1;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.LEVEL2_KEY;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedImmutableRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.SimpleImmutableRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.TIME_ATTR;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildBeanSchemaForNestedRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildBeanSchemaForSimpleRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildImmutableSchemaForNestedRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildImmutableSchemaForSimpleRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildNestedBeanRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildNestedBeanRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildNestedImmutableRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildNestedImmutableRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildNestedStaticRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildSimpleBeanRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildSimpleBeanRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildSimpleImmutableRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildSimpleImmutableRecordWithMap;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildSimpleStaticRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildStaticImmutableSchemaForNestedRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildStaticImmutableSchemaForSimpleRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildStaticSchemaForNestedRecordWithList;
import static software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.buildStaticSchemaForSimpleRecordWithList;

import java.time.Clock;
import java.time.Instant;
import java.time.ZoneOffset;
import java.util.Arrays;
import java.util.Collection;
import java.util.stream.Collectors;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.Parameterized;
import org.mockito.Mockito;
import software.amazon.awssdk.enhanced.dynamodb.DynamoDbEnhancedClient;
import software.amazon.awssdk.enhanced.dynamodb.DynamoDbTable;
import software.amazon.awssdk.enhanced.dynamodb.TableSchema;
import software.amazon.awssdk.enhanced.dynamodb.extensions.AutoGeneratedTimestampRecordExtension;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedBeanLevel2RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedBeanLevel3RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedBeanLevel4Record;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedBeanRecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedBeanRecordWithMap;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedImmutableLevel2RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedImmutableLevel3RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedImmutableLevel4Record;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedImmutableRecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedStaticLevel2RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedStaticLevel3RecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedStaticLevel4Record;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.NestedStaticRecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.SimpleBeanRecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.SimpleBeanRecordWithMap;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.SimpleImmutableRecordWithList;
import software.amazon.awssdk.enhanced.dynamodb.functionaltests.models.AutogeneratedTimestampModels.SimpleStaticRecordWithList;
import software.amazon.awssdk.services.dynamodb.model.ResourceNotFoundException;

@RunWith(Parameterized.class)
public class AutogeneratedTimestampTest extends LocalDynamoDbSyncTestBase {

    // Test configuration constants
    private static final String TIMESTAMP_STRING = "2019-01-13T14:00:00Z";
    private static final String INVALID_SCHEMA_ERROR = "Invalid table schema";

    // Table name suffixes
    private static final String BASE_TABLE_NAME = "autogen-timestamp-test";
    private static final String SIMPLE_BEAN_TABLE_SUFFIX = "-simple-bean-";
    private static final String NESTED_BEAN_TABLE_SUFFIX = "-nested-bean-";
    private static final String SIMPLE_IMMUTABLE_TABLE_SUFFIX = "-simple-immutable-";
    private static final String NESTED_IMMUTABLE_TABLE_SUFFIX = "-nested-immutable-";
    private static final String SIMPLE_STATIC_TABLE_SUFFIX = "-simple-static-";
    private static final String NESTED_STATIC_TABLE_SUFFIX = "-nested-static-";
    private static final String SIMPLE_STATIC_IMMUTABLE_TABLE_SUFFIX = "-simple-static-immutable-";
    private static final String NESTED_STATIC_IMMUTABLE_TABLE_SUFFIX = "-nested-static-immutable-";

    private static final Clock mockClock = Mockito.mock(Clock.class);
    private static final Instant MOCKED_INSTANT_NOW =
        Instant.now(Clock.fixed(Instant.parse(TIMESTAMP_STRING), ZoneOffset.UTC));
    private DynamoDbEnhancedClient enhancedClient;
    private String currentTestTableName;

    private enum RecordLevel {SIMPLE, NESTED}

    private enum SchemaType {BEAN, IMMUTABLE, STATIC, STATIC_IMMUTABLE}

    @Parameterized.Parameters(name = "{0}-{1}")
    public static Collection<Object[]> data() {
        return Arrays.stream(SchemaType.values())
                     .flatMap(schema -> Arrays.stream(RecordLevel.values())
                                              .map(level -> new Object[] {schema, level}))
                     .collect(Collectors.toList());
    }

    @Parameterized.Parameter(0)
    public SchemaType schemaType;

    @Parameterized.Parameter(1)
    public RecordLevel recordLevel;

    @Before
    public void beforeClass() {
        Mockito.when(mockClock.instant()).thenReturn(MOCKED_INSTANT_NOW);
        enhancedClient = DynamoDbEnhancedClient.builder()
                                               .dynamoDbClient(getDynamoDbClient())
                                               .extensions(AutoGeneratedTimestampRecordExtension.builder()
                                                                                                .baseClock(mockClock)
                                                                                                .build())
                                               .build();
    }

    @After
    public void deleteTable() {
        try {
            if (currentTestTableName != null) {
                getDynamoDbClient().deleteTable(r -> r.tableName(currentTestTableName));
            }
        } catch (ResourceNotFoundException e) {
            // Table didn't get created, ignore.
        }
    }


    @Test
    public void shouldPopulateTimestamps_forRecordWithList() {
        getTestCaseForRecordWithList(schemaType, recordLevel).run();
    }

    @Test
    public void shouldThrowException_forRecordWithSet() {
        if (schemaType == SchemaType.BEAN || schemaType == SchemaType.IMMUTABLE) {
            assertThatThrownBy(() -> getTestCaseForRecordWithSet(schemaType, recordLevel).run())
                .isInstanceOf(IllegalStateException.class)
                .hasMessageContaining("Converter not found for EnhancedType(java.util.Set<");
        } else {
            assertThatThrownBy(() -> getTestCaseForRecordWithSet(schemaType, recordLevel).run())
                .isInstanceOf(IllegalArgumentException.class)
                .hasMessageContaining("SetAttributeConverter cannot be created with a parameterized type of '");
        }
    }

    @Test
    public void shouldThrowException_forRecordWithMap() {
        if (schemaType == SchemaType.BEAN || schemaType == SchemaType.IMMUTABLE) {
            assertThatThrownBy(() -> getTestCaseForRecordWithMap(schemaType, recordLevel).run())
                .isInstanceOf(AssertionError.class)
                .hasMessageContaining("Expected: is <2019-01-13T14:00:00Z>\n     but: was null");
        } else {
            assertThatThrownBy(() -> getTestCaseForRecordWithMap(schemaType, recordLevel).run())
                .isInstanceOf(RuntimeException.class)
                .hasMessageContaining("Converter not found for EnhancedType(java.util.Map<java.lang.String,");
        }
    }


    private Runnable getTestCaseForRecordWithList(SchemaType schema, RecordLevel level) {
        switch (schema) {
            case BEAN:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenBeanSchema_onSimpleRecordWithList_populatesTimestamps
                       : this::testAutogeneratedTimestamp_givenBeanSchema_onNestedRecordWithList_populatesTimestamps;
            case IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenImmutableSchema_onSimpleRecordWithList_populatesTimestamps
                       : this::testAutogeneratedTimestamp_givenImmutableSchema_onNestedRecordWithList_populatesTimestamps;
            case STATIC:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenStaticSchema_onSimpleRecordWithList_populatesTimestamps
                       : this::testAutogeneratedTimestamp_givenStaticSchema_onNestedRecordWithList_populatesTimestamps;
            case STATIC_IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenStaticImmutableSchema_onSimpleRecordWithList_populatesTimestamps
                       : this::testAutogeneratedTimestamp_givenStaticImmutableSchema_onNestedRecordWithList_populatesTimestamps;
            default:
                return () -> {
                    throw new IllegalArgumentException(INVALID_SCHEMA_ERROR);
                };
        }
    }

    private Runnable getTestCaseForRecordWithSet(SchemaType schema, RecordLevel level) {
        switch (schema) {
            case BEAN:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildBeanSchemaForSimpleRecordWithSet
                       : AutogeneratedTimestampModels::buildBeanSchemaForNestedRecordWithSet;
            case IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildImmutableSchemaForSimpleRecordWithSet
                       : AutogeneratedTimestampModels::buildImmutableSchemaForNestedRecordWithSet;
            case STATIC:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildStaticSchemaForSimpleRecordWithSet
                       : AutogeneratedTimestampModels::buildStaticSchemaForNestedRecordWithSet;
            case STATIC_IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildStaticImmutableSchemaForSimpleRecordWithSet
                       : AutogeneratedTimestampModels::buildStaticImmutableSchemaForNestedRecordWithSet;
            default:
                return () -> {
                    throw new IllegalArgumentException(INVALID_SCHEMA_ERROR);
                };
        }
    }

    private Runnable getTestCaseForRecordWithMap(SchemaType schema, RecordLevel level) {
        switch (schema) {
            case BEAN:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenBeanSchema_onSimpleRecordWithMap_throwsException
                       : this::testAutogeneratedTimestamp_givenBeanSchema_onNestedRecordWithMap_throwsException;
            case IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? this::testAutogeneratedTimestamp_givenImmutableSchema_onSimpleRecordWithMap_throwsException
                       : this::testAutogeneratedTimestamp_givenImmutableSchema_onNestedRecordWithMap_throwsException;
            case STATIC:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildStaticSchemaForSimpleRecordWithMap
                       : AutogeneratedTimestampModels::buildStaticSchemaForNestedRecordWithMap;
            case STATIC_IMMUTABLE:
                return (level == RecordLevel.SIMPLE)
                       ? AutogeneratedTimestampModels::buildStaticImmutableSchemaForSimpleRecordWithMap
                       : AutogeneratedTimestampModels::buildStaticImmutableSchemaForNestedRecordWithMap;
            default:
                return () -> {
                    throw new IllegalArgumentException(INVALID_SCHEMA_ERROR);
                };
        }
    }


    // Bean table schema + Record with List
    private void testAutogeneratedTimestamp_givenBeanSchema_onSimpleRecordWithList_populatesTimestamps() {
        TableSchema<SimpleBeanRecordWithList> schema = buildBeanSchemaForSimpleRecordWithList();
        DynamoDbTable<SimpleBeanRecordWithList> table = createAndPut(SIMPLE_BEAN_TABLE_SUFFIX,
                                                                     schema,
                                                                     buildSimpleBeanRecordWithList());

        SimpleBeanRecordWithList result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildList());
        assertThat(result.getChildList().get(0).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildList().get(0).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildList().get(1).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildList().get(1).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenBeanSchema_onNestedRecordWithList_populatesTimestamps() {
        TableSchema<NestedBeanRecordWithList> schema = buildBeanSchemaForNestedRecordWithList();
        DynamoDbTable<NestedBeanRecordWithList> table = createAndPut(NESTED_BEAN_TABLE_SUFFIX,
                                                                     schema,
                                                                     buildNestedBeanRecordWithList());

        NestedBeanRecordWithList level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2List(), notNullValue());
        assertThat(level1.getLevel2List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedBeanLevel2RecordWithList level2 = level1.getLevel2();
        assertThat(level2, notNullValue());
        assertThat(level2.getAttr(), is(ATTR_LEVEL2));
        assertThat(level2.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3(), notNullValue());
        assertThat(level2.getLevel3().getAttr(), is(ATTR_LEVEL3));
        assertThat(level2.getLevel3().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3List(), notNullValue());
        assertThat(level2.getLevel3List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedBeanLevel3RecordWithList level3 = level2.getLevel3();
        assertThat(level3, notNullValue());
        assertThat(level3.getAttr(), is(ATTR_LEVEL3));
        assertThat(level3.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4(), notNullValue());
        assertThat(level3.getLevel4().getAttr(), is(ATTR_LEVEL4));
        assertThat(level3.getLevel4().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4List(), notNullValue());
        assertThat(level3.getLevel4List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedBeanLevel4Record level4 = level3.getLevel4();
        assertThat(level4, notNullValue());
        assertThat(level4.getAttr(), is(ATTR_LEVEL4));
        assertThat(level4.getTime(), is(MOCKED_INSTANT_NOW));
    }

    // Bean table schema + Record with Map
    private void testAutogeneratedTimestamp_givenBeanSchema_onSimpleRecordWithMap_throwsException() {
        TableSchema<SimpleBeanRecordWithMap> schema = AutogeneratedTimestampModels.buildBeanSchemaForSimpleRecordWithMap();
        DynamoDbTable<SimpleBeanRecordWithMap> table = createAndPut(SIMPLE_BEAN_TABLE_SUFFIX,
                                                                    schema,
                                                                    buildSimpleBeanRecordWithMap());

        SimpleBeanRecordWithMap result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildMap());
        assertThat(result.getChildMap().get(CHILD1_KEY).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildMap().get(CHILD1_KEY).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildMap().get(CHILD2_KEY).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildMap().get(CHILD2_KEY).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenBeanSchema_onNestedRecordWithMap_throwsException() {
        TableSchema<NestedBeanRecordWithMap> schema = AutogeneratedTimestampModels.buildBeanSchemaForNestedRecordWithMap();
        DynamoDbTable<NestedBeanRecordWithMap> table = createAndPut(SIMPLE_BEAN_TABLE_SUFFIX,
                                                                    schema,
                                                                    buildNestedBeanRecordWithMap());

        NestedBeanRecordWithMap level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertNotNull(level1.getLevel2Map());
        assertThat(level1.getLevel2Map().get(LEVEL2_KEY).getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2Map().get(LEVEL2_KEY).getTime(), is(MOCKED_INSTANT_NOW));
    }

    // Immutable table schema + Record with Map
    private void testAutogeneratedTimestamp_givenImmutableSchema_onSimpleRecordWithMap_throwsException() {
        TableSchema<SimpleImmutableRecordWithMap> schema =
            AutogeneratedTimestampModels.buildImmutableSchemaForSimpleRecordWithMap();
        DynamoDbTable<SimpleImmutableRecordWithMap> table = createAndPut(SIMPLE_IMMUTABLE_TABLE_SUFFIX,
                                                                         schema,
                                                                         buildSimpleImmutableRecordWithMap());

        SimpleImmutableRecordWithMap result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildMap());
        assertThat(result.getChildMap().get(CHILD1_KEY).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildMap().get(CHILD1_KEY).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildMap().get(CHILD2_KEY).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildMap().get(CHILD2_KEY).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenImmutableSchema_onNestedRecordWithMap_throwsException() {
        TableSchema<NestedImmutableRecordWithMap> schema =
            AutogeneratedTimestampModels.buildImmutableSchemaForNestedRecordWithMap();
        DynamoDbTable<NestedImmutableRecordWithMap> table = createAndPut(NESTED_IMMUTABLE_TABLE_SUFFIX,
                                                                         schema,
                                                                         buildNestedImmutableRecordWithMap());

        NestedImmutableRecordWithMap level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertNotNull(level1.getLevel2Map());
        assertThat(level1.getLevel2Map().get(LEVEL2_KEY).getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2Map().get(LEVEL2_KEY).getTime(), is(MOCKED_INSTANT_NOW));
    }

    // Immutable table schema + Record with List
    private void testAutogeneratedTimestamp_givenImmutableSchema_onSimpleRecordWithList_populatesTimestamps() {
        TableSchema<SimpleImmutableRecordWithList> schema = buildImmutableSchemaForSimpleRecordWithList();
        DynamoDbTable<SimpleImmutableRecordWithList> table = createAndPut(SIMPLE_IMMUTABLE_TABLE_SUFFIX,
                                                                          schema,
                                                                          buildSimpleImmutableRecordWithList());

        SimpleImmutableRecordWithList result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildList());
        assertThat(result.getChildList().get(0).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildList().get(0).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildList().get(1).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildList().get(1).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenImmutableSchema_onNestedRecordWithList_populatesTimestamps() {
        TableSchema<NestedImmutableRecordWithList> schema = buildImmutableSchemaForNestedRecordWithList();
        DynamoDbTable<NestedImmutableRecordWithList> table = createAndPut(NESTED_IMMUTABLE_TABLE_SUFFIX,
                                                                          schema,
                                                                          buildNestedImmutableRecordWithList());

        NestedImmutableRecordWithList level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2List(), notNullValue());
        assertThat(level1.getLevel2List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel2RecordWithList level2 = level1.getLevel2();
        assertThat(level2, notNullValue());
        assertThat(level2.getAttr(), is(ATTR_LEVEL2));
        assertThat(level2.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3(), notNullValue());
        assertThat(level2.getLevel3().getAttr(), is(ATTR_LEVEL3));
        assertThat(level2.getLevel3().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3List(), notNullValue());
        assertThat(level2.getLevel3List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel3RecordWithList level3 = level2.getLevel3();
        assertThat(level3, notNullValue());
        assertThat(level3.getAttr(), is(ATTR_LEVEL3));
        assertThat(level3.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4(), notNullValue());
        assertThat(level3.getLevel4().getAttr(), is(ATTR_LEVEL4));
        assertThat(level3.getLevel4().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4List(), notNullValue());
        assertThat(level3.getLevel4List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel4Record level4 = level3.getLevel4();
        assertThat(level4, notNullValue());
        assertThat(level4.getAttr(), is(ATTR_LEVEL4));
        assertThat(level4.getTime(), is(MOCKED_INSTANT_NOW));
    }

    // Static table schema + Record with List
    private void testAutogeneratedTimestamp_givenStaticSchema_onSimpleRecordWithList_populatesTimestamps() {
        DynamoDbTable<SimpleStaticRecordWithList> table = createAndPut(SIMPLE_STATIC_TABLE_SUFFIX,
                                                                       buildStaticSchemaForSimpleRecordWithList(),
                                                                       buildSimpleStaticRecordWithList());

        SimpleStaticRecordWithList result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildList());
        assertThat(result.getChildList().get(0).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildList().get(0).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildList().get(1).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildList().get(1).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenStaticImmutableSchema_onSimpleRecordWithList_populatesTimestamps() {
        DynamoDbTable<SimpleImmutableRecordWithList> table = createAndPut(SIMPLE_STATIC_IMMUTABLE_TABLE_SUFFIX,
                                                                          buildStaticImmutableSchemaForSimpleRecordWithList(),
                                                                          buildSimpleImmutableRecordWithList());

        SimpleImmutableRecordWithList result = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(result.getAttr(), is(ATTR_LEVEL1));
        assertThat(result.getTime(), is(MOCKED_INSTANT_NOW));

        assertNotNull(result.getChildList());
        assertThat(result.getChildList().get(0).getAttr(), is(ATTR_CHILD1));
        assertThat(result.getChildList().get(0).getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(result.getChildList().get(1).getAttr(), is(ATTR_CHILD2));
        assertThat(result.getChildList().get(1).getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenStaticSchema_onNestedRecordWithList_populatesTimestamps() {
        DynamoDbTable<NestedStaticRecordWithList> table = createAndPut(NESTED_STATIC_TABLE_SUFFIX,
                                                                       buildStaticSchemaForNestedRecordWithList(),
                                                                       buildNestedStaticRecordWithList());

        NestedStaticRecordWithList level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2List(), notNullValue());
        assertThat(level1.getLevel2List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedStaticLevel2RecordWithList level2 = level1.getLevel2();
        assertThat(level2, notNullValue());
        assertThat(level2.getAttr(), is(ATTR_LEVEL2));
        assertThat(level2.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3(), notNullValue());
        assertThat(level2.getLevel3().getAttr(), is(ATTR_LEVEL3));
        assertThat(level2.getLevel3().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3List(), notNullValue());
        assertThat(level2.getLevel3List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedStaticLevel3RecordWithList level3 = level2.getLevel3();
        assertThat(level3, notNullValue());
        assertThat(level3.getAttr(), is(ATTR_LEVEL3));
        assertThat(level3.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4(), notNullValue());
        assertThat(level3.getLevel4().getAttr(), is(ATTR_LEVEL4));
        assertThat(level3.getLevel4().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4List(), notNullValue());
        assertThat(level3.getLevel4List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedStaticLevel4Record level4 = level3.getLevel4();
        assertThat(level4, notNullValue());
        assertThat(level4.getAttr(), is(ATTR_LEVEL4));
        assertThat(level4.getTime(), is(MOCKED_INSTANT_NOW));
    }

    private void testAutogeneratedTimestamp_givenStaticImmutableSchema_onNestedRecordWithList_populatesTimestamps() {
        DynamoDbTable<NestedImmutableRecordWithList> table = createAndPut(NESTED_STATIC_IMMUTABLE_TABLE_SUFFIX,
                                                                          buildStaticImmutableSchemaForNestedRecordWithList(),
                                                                          buildNestedImmutableRecordWithList());

        NestedImmutableRecordWithList level1 = table.getItem(r -> r.key(k -> k.partitionValue(ID_1)));

        assertThat(level1, notNullValue());
        assertThat(level1.getAttr(), is(ATTR_LEVEL1));
        assertThat(level1.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2(), notNullValue());
        assertThat(level1.getLevel2().getAttr(), is(ATTR_LEVEL2));
        assertThat(level1.getLevel2().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level1.getLevel2List(), notNullValue());
        assertThat(level1.getLevel2List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel2RecordWithList level2 = level1.getLevel2();
        assertThat(level2, notNullValue());
        assertThat(level2.getAttr(), is(ATTR_LEVEL2));
        assertThat(level2.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3(), notNullValue());
        assertThat(level2.getLevel3().getAttr(), is(ATTR_LEVEL3));
        assertThat(level2.getLevel3().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level2.getLevel3List(), notNullValue());
        assertThat(level2.getLevel3List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel3RecordWithList level3 = level2.getLevel3();
        assertThat(level3, notNullValue());
        assertThat(level3.getAttr(), is(ATTR_LEVEL3));
        assertThat(level3.getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4(), notNullValue());
        assertThat(level3.getLevel4().getAttr(), is(ATTR_LEVEL4));
        assertThat(level3.getLevel4().getTime(), is(MOCKED_INSTANT_NOW));
        assertThat(level3.getLevel4List(), notNullValue());
        assertThat(level3.getLevel4List(), everyItem(hasProperty(TIME_ATTR, is(MOCKED_INSTANT_NOW))));

        NestedImmutableLevel4Record level4 = level3.getLevel4();
        assertThat(level4, notNullValue());
        assertThat(level4.getAttr(), is(ATTR_LEVEL4));
        assertThat(level4.getTime(), is(MOCKED_INSTANT_NOW));
    }

    // Helper for table creation + item insert
    private <T> DynamoDbTable<T> createAndPut(String tableSuffix, TableSchema<T> schema, T item) {
        currentTestTableName = BASE_TABLE_NAME + tableSuffix + System.nanoTime();
        DynamoDbTable<T> table = enhancedClient.table(currentTestTableName, schema);
        table.createTable(r -> r.provisionedThroughput(getDefaultProvisionedThroughput()));
        table.putItem(item);
        return table;
    }
}
